<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="question-header"></a><a href="https://ru.stackoverflow.com/questions/617107/%d0%9f%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%b8-%d0%b8%d0%b7%d0%bc%d0%b5%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5-%d1%80%d0%b0%d1%81%d0%ba%d0%bb%d0%b0%d0%b4%d0%ba%d0%b8-%d0%ba%d0%bb%d0%b0%d0%b2%d0%b8%d0%b0%d1%82%d1%83%d1%80%d1%8b"><span style=" text-decoration: underline; color:#0000ff;">П</span></a>олучение и изменение раскладки клавиатуры</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629; vertical-align:top;">Как можно узнать раскладку клавиатуры в определенном окне/процессе и сменить её?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; vertical-align:top;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://python.su/forum/topic/1946/"><span style=" font-family:'inherit'; font-size:13px; text-decoration: underline; color:#0000ff;">Здесь</span></a><span style=" font-family:'inherit'; font-size:13px; color:#232629;"> описано, как можно определить текущий язык раскладки. Таким образом, метод определения языка раскладки может выглядеть так:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'inherit'; font-size:13px; color:#000000;">import</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> ctypes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">      </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'inherit'; font-size:13px; color:#000000;">def</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">get_layout</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">():</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">    u = ctypes.windll.LoadLibrary(</span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">&quot;user32.dll&quot;</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">    pf = </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">getattr</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">(u, </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">&quot;GetKeyboardLayout&quot;</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">    </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">if</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">hex</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">(pf(</span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">0</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">)) == </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">'0x4190419'</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">        </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">return</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">'ru'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">    </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">if</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">hex</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">(pf(</span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">0</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">)) == </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">'0x4090409'</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">        </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">return</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> </span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">'en'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">изменить раскладку клавиатуры например на английский:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'inherit'; font-size:13px; color:#000000;">import</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> py_win_keyboard_layout</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">py_win_keyboard_layout.change_foreground_window_keyboard_layout(</span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">0x04090409</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">Для того, чтобы выполнить задачу необходимо установить дополнительную библиотеку pywin32, которая предоставляет доступ к функциям Windows API из Python. Из этой библиотеки нам понадобится модуль win32api.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'inherit'; font-size:13px; color:#000000;">&gt;&gt;&gt; import</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> win32api</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">Исследовав его содержимое можно увидеть, что для работы с раскладкой клавиатуры есть несколько функций и одно системное сообщение Windows - WM_INPUTLANGCHANGE:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">GetKeyboardLayout</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">GetKeyboardLayoutList</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">LoadKeyboardLayout</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">В данном случае для нас важна именно последняя функция - LoadKeyboardLayout. Данная функция загружает новую раскладку (если она еще не загружена) и предпринимает после этого еще какие-то действия; принимает в качестве аргументов два параметра:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">строка с идентификатором раскладки.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">действие</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">Более подробно о их возможных значениях можно почитать в MSDN. Итак, нам важны две вещи:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">Получить идентификатор раскладки.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Consolas'; font-size:13px; color:#232629; background-color:#eff0f1;">Вторым параметром передать действие переключения на загруженную раскладку.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">Первый параметр мы можем с легкостью получить из реестра по пути: </span><span style=" font-family:'Courier New'; font-size:13px; color:#000000;">HKEY_CURRENT_USER/Keyboard Layout/Preload</span><span style=" font-family:'inherit'; font-size:13px; color:#232629;">. Итак, выберем переключение на русский язык. В реестре видим примерно следующее: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'inherit'; font-size:13px; color:#232629;">Значение записи реестра как раз и будет нужным идентификатором раскладки. Итак, все, что надо сделать:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'inherit'; font-size:13px; color:#000000;">&gt;&gt;&gt; import</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;"> win32api</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'inherit'; font-size:13px; color:#000000;">&gt;&gt;&gt; </span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">win32api.LoadKeyboardLayout(</span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">&quot;00000419&quot;</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">,</span><span style=" font-family:'inherit'; font-size:13px; color:#000000;">1</span><span style=" font-family:'Consolas'; font-size:13px; color:#232629;">)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629; background-color:#eff0f1;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:10px; color:#232629;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#232629;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'inherit'; font-size:13px; color:#000000;"><br /></p></body></html>