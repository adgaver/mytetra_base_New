<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:24pt; font-weight:600;">Регулярные выражения (RegExp) в Power Query</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">509 15.07.2020 </span><a href="https://www.planetaexcel.ru/upload/iblock/cc1/regexp-in-power-query.xlsx"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Скачать пример</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Если вы хотя бы чуть-чуть знакомы с регулярными выражениями, то рекламировать вам их не нужно. Если же вы не совсем в теме, то регулярные выражения (Regular Expressions = RegExp = &quot;регэкспы&quot; = &quot;регулярки&quot;) - это язык, где с помощью специальных символов и правил производится поиск нужных подстрок в тексте, их извлечение или замена на другой текст. Это очень мощный и красивый инструмент, на порядок превосходящий по возможностям все остальные способы работы с текстом. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Я уже подробно и с кучей примеров из жизни описывал, как можно </span><a href="https://www.planetaexcel.ru/techniques/7/4844/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">добавить поддержку регулярных выражений в Excel</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> с помощью несложных макросов - если вы ещё не читали эту статью, то крайне рекомендую с ней ознакомиться прежде чем продолжать. Откроете для себя много нового, гарантирую :) </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Открытым, тем не менее, остается вопрос - а как добавить возможность использовать регулярные выражения в Power Query? Power Query, конечно, хороша и сама по себе и много чего умеет делать с текстом (резать, клеить, чистить и т.д.), но если бы удалось скрестить это с мощью регулярных выражений - это была бы просто бомба.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Встроенных функций для работы с RegExp'ами в Power Query, к сожалению, нет и официальная справка и техподдержка Microsoft отвечают на этот вопрос отрицательно. Однако, есть способ обойти это ограничение :) </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">Суть метода</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Главная идея проста до безобразия. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">В списке встроенных возможностей Power Query есть функция </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Web.Page</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. </span><a href="https://docs.microsoft.com/en-us/powerquery-m/web-page"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Описание этой функции на оф.сайте справки Microsoft</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> предельно лаконично: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">В переводе это будет: &quot;Возвращает содержимое документа HTML, разбитого на составные структуры, а также представление полного документа и его текста после удаления тегов.&quot; Так себе описание, прямо скажем.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Обычно эта функция используется при импорте данных из веба и автоматически подставляется, например, когда мы выбираем на вкладке </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Данные </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">команду </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Из интернета </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Data - From web)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Мы даём функции в качестве аргумента веб-страницу, а она возвращает нам её содержимое в виде таблиц, вычистив предварительно все теги. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Что в справке НЕ написано, так это то, что помимо языка разметки HTML </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">функция Web.Page поддерживает скрипты на языке JavaScript</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, который сейчас повсеместно используется на веб-сайтах в интернете. А JavaScript, в свою очередь, всегда умел работать с регулярными выражениями и имеет встроенные функции для RegExp'ов! Так что для реализации регулярок в Power Query нам нужно будет скормить функции Web.Page в качестве аргумента маленькую программку на JavaScript, которая и сделает за Power Query всю работу. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">Как это выглядит на чистом JavaScript</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Подробных руководств по работе с регулярными выражениями на JavaScript в интернете - масса (например, </span><a href="https://javascript.ru/REGexp"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">раз</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, </span><a href="https://msiter.ru/tutorials/javascript/js_regexp"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">два</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Если коротко и упрощенно, то код на JavaScript будет выглядет так: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1595096759pwfv64v6o6.png" /><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Здесь: </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Consolas'; font-size:12pt; color:#2f3192;">var str = 'Оплата по счетам 123 и 789 за колбасу&quot;;</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - создаем переменную </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">str</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и присваиваем ей исходный текст, который будем анализировать.</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Consolas'; font-size:12pt; color:#2f3192;">var pattern = /\d+/gi;</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - создаем регулярное выражение и помещаем его в переменную </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">pattern</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. <br />Выражение начинается знаком слэш (/).<br />Само выражение здесь, для примера, это </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#007236;">\d+</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - обозначает любую последовательности цифр. <br />Через дробь после выражения идут дополнительные параметры (модификаторы) поиска - их можно указывать в любом порядке:</span> </li>
<ul type="circle" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">g</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - означает глобальный поиск, т.е. после нахождения совпадения нужно не останавливаться, а продолжать поиск до конца текста. Если этот модификатор не задан, то наш скрипт выдаст только первое совпадение (123)</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">i</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - поиск без учёта регистра букв</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">m</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - многострочный поиск (применяется, когда исходный текст разбит на несколько строк)</span> </li></ul>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Consolas'; font-size:12pt; color:#2f3192;">var result = str.match(pattern).join(';');</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - выполняем поиск в исходном тексте (</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">str</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) по заданному регулярному выражению (</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">pattern</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) и помещаем результаты в переменную </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">result</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, сцепив их через точку с запятой с помощью команды </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">join</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Consolas'; font-size:12pt; color:#2f3192;">document.write(result);</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - выводим на экран содержимое переменной result</span> </li></ul>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Также обратите внимание, что текстовые строки (за исключением регулярного выражения) в JavaScript заключаются в апострофы, а не в кавычки, как в Power Query или VBA. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">На выходе этот скрипт выдаст нам в качестве результата все числа, найденные в исходном тексте: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">123;789</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Краткий курс по JavaScript закончен, всем спасибо. Надеюсь, вы ухватили логику :) </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Осталось перенести эту конструкцию в Power Query. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">Функция поиска и извлечения текста по регулярному выражению в Power Query</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Делаем следующее:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#f16522;">1</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Открываем Excel и создаем новый пустой запрос Power Query на вкладке </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Данные - Получить данные / Создать запрос - Из других источников - Пустой запрос </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Data - Get data / New query - From other sources - Blank query)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Если у вас старая версия Excel 2010-2013 и Power Query у вас не встроена, а была установлена как отдельная надстройка, то всё это будет на вкладке </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Power Query</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, а не </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Данные</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#f16522;">2</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. В открывшемся пустом окне редактора запросов в правой панели сразу вводим имя нашей будущей функции (например, </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">fxRegExpExtract</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) <br /><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#f16522;">3</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Идём на вкладку </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Просмотр - Расширенный редактор </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(View - Advanced Editor)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, стираем весь М-код пустого запроса и вставляем туда код нашей суперфункции: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Следите за руками: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">В первой строке мы говорим, что в нашей функции будет три текстовых аргумента: </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">txt </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">- исходный анализируемый текст, </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">regex </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">- шаблон регулярного выражения, </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">delim </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">- символ-разделитель для вывода результатов. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Далее вызываем функцию </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Web.Page</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, формируя у нее в аргументе описанный выше код на JavaScript. В код вклеиваем и подставляем наши аргументы-переменные. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Фрагмент: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">[Data]{0}[Children]{0}[Children]{1}[Text]{0} </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">... нужен, чтобы &quot;провалиться&quot; в нужную нам таблицу с результатами. Дело в том, что функция </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Web.Page</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> в качестве результата выдает несколько вложенных друг в друга таблиц, повторяющих структуру веб-страницы. Без этого фрагмента М-кода наша функция выдавала бы на выходе это: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">... и нам пришлось бы несколько раз щелкать мышью по слову </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#007236;">Table</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, последовательно &quot;проваливаясь&quot; в дочерние вложенные таблицы в столбцах </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Children</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">:<br /><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Вместо всей этой котовасии мы сразу в коде нашей функции указываем какая вложенная таблица и столбец (</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Text</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) нам нужны. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Вот, собственно, и всё секреты. Осталось нажать на кнопку </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Готово </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">в окне </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Расширенного редактора</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, куда мы вставили наш код, и можно приступать к самому вкусному - пробовать нашу функцию в работе. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Вот вам пара примеров для затравки. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">Пример 1. Извлекаем номер счета и дату из описания платежа</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Имеем банковскую выписку с описанием (назначением) платежей, где нужно вытащить в отдельные столбцы номера и даты оплаченных счетов:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Грузим таблицу в Power Query стандартным образом через </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Данные - Из таблицы / диапазона </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Data - From Table/Range)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Затем добавляем вычисляемый столбец с нашей функцией через </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Добавление столбца - Вызывать настраиваемую функцию </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Add Column - Invoke Custom Function)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и вводим её аргументы: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">В качестве регулярного выражения (аргумент </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">regex</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) используем шаблон: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">(</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; color:#0000ff;">\d{3,5}</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">|</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; color:#ee105a;">\d{2}\.\d{2}\.\d{4}</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">)</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">... в переводе на человеческий язык означающий:  </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; color:#0000ff;">числа от 3 до 5 разрядов (номера счетов)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">или </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; color:#ee105a;">фрагменты вида &quot;2-разрядное число - точка - 2-разрядное число - точка - 4-разрядное число&quot;</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, то бишь даты вида ДД.ММ.ГГГГ.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">В качестве символа-разделителя (аргумент </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">delim</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) вводим точку с запятой. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">После нажатия на </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">ОК</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> наша волшебная функция анализирует все исходные данные по нашему регулярному выражению и формирует нам столбец с найденными номерами и датами счетов: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Останется его разделить по точке с запятой с помощью команды </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Главная - Разделить столбец - По разделителю </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Home - Split column - By delimiter)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и мы получим то, что хотели:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Красота!</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">Пример 2. Извлекаем адреса эл.почты из текста</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Предположим, что у нас в качестве исходных данных есть вот такая таблица: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">... откуда нам нужно вытащить встречающиеся там адреса эл.почты (для наглядности я выделил их в тексте красным).</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Как и в прошлом примере, грузим таблицу в Power Query стандартным образом через </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Данные - Из таблицы / диапазона </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Data - From Table/Range)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Затем добавляем вычисляемый столбец с нашей функцией через </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Добавление столбца - Вызывать настраиваемую функцию </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; color:#cccccc;">(Add Column - Invoke Custom Function)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и вводим её аргументы: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Парсинг адресов эл.почты - задача посложнее и для её решения есть куча регулярок разной степени кошмарности. Я использовал один из простых вариантов - не идеальный, но вполне работающий в большинстве случаев: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">[\w|.|-]*@\w*\.[\w|.]* </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">В качестве разделителя (</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">delim</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) можно ввести точку с запятой и пробел. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Жмём на </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">ОК</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и получаем столбец с извлеченными из исходной текстовой &quot;каши&quot; адресами эл.почты: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> </span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Магия!</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">P.S.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Как говорится: &quot;нет такой хорошей вещи, которую нельзя было бы сделать ещё лучше&quot;. Power Query и сам-то по себе крут, а уж в сочетании с регулярными выражениями даёт нам совершенно нереальную мощь и гибкость в обработке любых текстовых данных. Надеюсь, Microsoft когда-нибудь добавит поддержку RegExp в обновлениях Power Query и Power BI и все описанные выше танцы с бубном останутся в прошлом. Ну, а пока - так.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Также вдогон хочу добавить, что с регулярными выражениями удобно играться на сайте </span><a href="https://regexr.com/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">https://regexr.com/</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - прямо в онлайн-редакторе. Там же в разделе </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Community Patterns</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> есть огромное количество готовых регулярок на все случаи жизни. Экспериментируйте - вся мощь регулярных выражений теперь к вашим услугам и в Power Query!</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:13.5pt; font-weight:600;">Ссылки по теме</span><span style=" font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.planetaexcel.ru/techniques/7/4844/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Что такое регулярные выражения (RegExp) и как использовать их в Excel</span></a> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.planetaexcel.ru/techniques/24/11627/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Нечёткий текстовый поиск в Power Query</span></a> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.planetaexcel.ru/techniques/24/2152/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Сборка таблиц из разных файлов с помощью Power Query</span></a> </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">  </span></p></body></html>