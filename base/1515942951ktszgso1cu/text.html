<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600;">15. Арифметика чисел с плавающей точкой: проблемы и ограничения </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Числа с плавающей точкой представлены в компьютерном железе как дроби с основанием 2 (двоичная система счисления). Например, десятичная дробь </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.125</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">имеет значение 1/10 + 2/100 + 5/1000, и таким же образом двоичная дробь </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.001</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">имеет значение 0/2 + 0/4 + 1/8. Эти две дроби имеют одинаковые значения, отличаются только тем, что первая записана в дробной нотации по основанию 10, а вторая по основанию 2. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">К сожалению, большинство десятичных дробей не могут быть точно представлены в двоичной записи. Следствием этого является то, что в основном десятичные дробные числа вы вводите только приближенными к двоичным, которые и сохраняются в компьютере. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Проблему легче понять сначала в десятичной системе счисления. Рассмотрим дробь 1/3. Вы можете приблизительно представить ее десятичной дробью: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.3</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">или лучше </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.33</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">еще лучше </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.333</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">и так далее. Независимо от того, как много цифр вы запишите, результат никогда не будет точно 1/3, но будет все более лучшим приближением к 1/3. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Точно также не важно, как много цифр с основанием 2 вы будете использовать, десятичное значение 0.1 не может быть представлено точно в двоичной записи дроби. По основанию 2 дробь 1/10 - это бесконечно повторяющаяся дробь </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.0001100110011001100110011001100110011001100110011...</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Остановка при любом конечном количестве бит приведет к получению приближения. Сегодня на большинстве компьютеров вещественные числа приближены с использованием бинарных дробей, чей числитель использует первые 53 бита, начиная с самого значимого  бита, и чей знаменатель является степенью двойки. В случае 1/10, бинарная дробь есть </span><span style=" font-family:'Courier New,courier'; font-size:9pt;">3602879701896397 / 2 ** 55</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">, которая близка, но не точно равна действительному значению 1/10. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Многие пользователи не осведомлены о приближении из-за способа отображения значений. Python выводит только десятичное приближение настоящего десятичного значения от двоичного приближения, хранимого на компьютере. На большинстве машин, если бы Python выводил настоящее десятичное значение двоичного приближения 0.1, то тогда бы отобразилось следующее </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; 0.1</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.1000000000000000055511151231257827021181583404541015625</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Здесь больше цифр, чем большинство людей найдут полезными, поэтому, вместо этого, Python позволяет управлять количеством цифр, отображая округленное значение </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; 1 / 10</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.1</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Просто помните, даже если отображенный результат выглядит как точное значение 1/10, на самом деле хранимое значение - самое близкое представление бинарной дроби. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Примечательно, что есть множество различных десятичных чисел, которые разделяют одинаковую самую близкую приблизительную двоичную дробь. Например, число  0.1 и 0.10000000000000001 и 0.1000000000000000055511151231257827021181583404541015625 являются все приближенными к 3602879701896397 / 2 ** 55. Поскольку все эти десятичные значения разделяют одно и тоже приближение, любой один из них мог бы быть отображен при сохранении инварианта </span><span style=" font-family:'Courier New,courier'; font-size:9pt;">eval(repr(x)) == x</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Исторически, приглашение Python и встроенная функция repr() выбрали бы одну из 17 значащих цифр, </span><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.10000000000000001</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">. Начиная с Python 3.1, на большинстве систем теперь Python способен выбрать самую короткую из них и просто отобразить </span><span style=" font-family:'Courier New,courier'; font-size:9pt;">0.1</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Заметьте, что это очень естественно для двоичного вещественного числа: это не баг в Python и также не баг в вашем коде. Вы увидите то же самое во всех языках, которые поддерживают арифметику с плавающей точкой вашего железа (хотя некоторые языки могут не отображать различия по-умолчанию, или во всех режимах вывода). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Для более приятного вывода вы можете пожелать использовать строковое форматирование для создания ограниченного числа значащих цифр: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; format(math.pi, '.12g')  # задает 12 значащих цифр</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">'3.14159265359'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; format(math.pi, '.2f')   # задает 2 цифры после запятой</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">'3.14'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; repr(math.pi)</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">'3.141592653589793'</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Важно осознавать, что в реальном понимании это иллюзия: вы просто округляете вывод действительного машинного значения. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Одна иллюзия может порождать другую. Например, поскольку 0.1 не точно 1/10, суммирование трех значений 0.1 может не произвести точно 0.3, либо: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; .1 + .1 + .1 == .3</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">False</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Т</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">акже, поскольку 0.1 не может приблизиться к точному значению 1/10 и 0.3 не может приблизиться к точной величине 3/10, то предварительное округление с помощью функции </span><a href="http://pythoner.name/documentation/library/functions#round"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; text-decoration: underline; color:#0000ff;">round()</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> не может помочь: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; round(.1, 1) + round(.1, 1) + round(.1, 1) == round(.3, 1)</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">False</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Х</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">отя цифры не могут быть приближены к их предназначенным точным значениям, функция round() может быть полезна для пост-округления, так что результаты с неточными значениями становятся сопоставимы друг с другом: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; round(.1 + .1 + .1, 10) == round(.3, 10)</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">True</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Двоичная арифметика чисел с плавающей точкой содержит много сюрпризов подобных этому. Проблема с &quot;0.1&quot; объяснена в точных деталях ниже, в разделе &quot;Представление ошибок&quot;. См. The Perils of Floating Point, где более полный отчет о других обычных сюрпризах. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">К</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">ак говорится ближе к концу: &quot;нет легких ответов&quot;. Но спокойно, не будьте чрезмерно осторожны насчет вещественных чисел! Ошибки в операциях с вещественными числами в Python унаследованы от чисел с плавающей точкой железа, и на большинстве машин </span><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">с</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">оставляет не более 1 части в 2**53 за операцию. Это более чем адекватно для большинства задач, но вам нужно иметь в виду, что это не десятичная арифметика и что каждая вещественная операция может претерпевать новую ошибку округления. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Хотя патологические случаи действительно существуют, в повседневности, используя арифметику чисел с плавающей точкой, в конце вы будете видеть тот результат, который ожидали, если вы просто округляете финальные результаты к определенному количеству десятичных чисел. </span><a href="http://pythoner.name/documentation/library/stdtypes#str"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; text-decoration: underline; color:#0000ff;">str()</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> обычно достаточно, а для более тонкого контроля см. </span><a href="http://pythoner.name/documentation/library/stdtypes#str.format"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; text-decoration: underline; color:#0000ff;">str.format()</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> спецификаторы формата метода в Format String Syntax (docs.python.org/3/library/string.html#formatstrings). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Для случаев, которые требуют точного десятичного представления, попробуйте использовать модуль decimal (docs.python.org/3/library/decimal.html#module-decimal), который реализует десятичную арифметику, подходящую для бухгалтерских приложений и высокоточных приложений. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Другая форма точной арифметики поддерживается модулем fractions (docs.python.org/3/library/fractions.html#module-fractions), который реализует арифметику, основанную на рациональных числах (так числа подобные 1/3 могут быть представлены точно). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Если вы сильно используете операции с плавающей точкой, вам следует взглянуть на пакет Numerical Python и множество других пакетов для математических и статистических операций, предоставляемых проектом SciPy. См. &lt;scipy.org&gt;. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Python предоставляет инструменты, которые могут помочь в тех редких случаях, когда вы действительно хотите знать точное значение вещественного числа. Метод </span><a href="http://pythoner.name/documentation/library/stdtypes#float.as_integer_ratio"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; text-decoration: underline; color:#0000ff;">float.as_integer_ratio()</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> выражает значение вещественного числа как дробь: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; x = 3.14159</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; x.as_integer_ratio()</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">(3537115888337719, 1125899906842624)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Поскольку это соотношение точное, оно может быть использовано, чтобы без потерь воссоздать первоначальное значение: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; x == 3537115888337719 / 1125899906842624</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">True</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Метод float.hex() выражает вещественное число в шестнадцатеричной (с основанием 16) системе счисления, снова давая точное значение, хранимое вашим компьютером: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; x == float.fromhex('0x1.921f9f01b866ep+1')</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">True</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Поскольку представление точно, это полезно для надежного переноса значений через различные версии Python (платформенная независимость) и обмена данными с другими языками, которые поддерживают такой же формат (такие как Java и C99). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Другой полезный инструмент - функция math.fsum() (docs.python.org/3/library/math.html#math.fsum), которая помогает смягчить потерю точности во время суммирования. Она отслеживает &quot;потерянные цифры&quot; как значения, добавляемые к текущему итогу. </span><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Э</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">то может повлиять на общую точность, так что ошибки не накапливались до такой степени, чтобы влиять на итоговое значение: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; sum([0.1] * 10) == 1.0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">False</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; math.fsum([0.1] * 10) == 1.0</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">True</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="representation-error"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600;">1</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600;">5.1. Ошибки представления</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Этот раздел разъясняет &quot;0.1&quot; пример в деталях и показывает, как вы можете представить точный анализ таких случаев.</span><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> </span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Предполагается базовое знакомство с двоичным представлением чисел с плавающей точкой. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Ошибки представления относятся к тому факту, что некоторые (большинство, на самом деле) десятичные дроби не могут быть представлены точно как двоичные (с основанием 2) дроби. Это главная причина, почему Python (или Perl, C, C++, Java, Fortran и многие другие) обычно не будут отображать точное десятичное число, которое вы ожидаете. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Почему это так? 1/10 нельзя точно представить в виде двоичной дроби. Почти все компьютеры сегодня (ноябрь 2000) используют IEEE-754 арифметику вещественных чисел, и почти все платформы отображают вещественные числа Python в IEEE-754 &quot;двойной точности&quot;. Двойные 754 содержат 53 бита точности, так п</span><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">р</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">и вводе компьютер стремится преобразовать 0,1 в ближайшую дробь, это может иметь вид J/2** N, где J - целое число, содержащее ровно 53 бита. Перезаписывая </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">1 / 10 ~= J / (2**N)</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">как </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">J ~= 2**N / 10</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">и вспоминая, что J имело точно 53 бита (является </span><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;= 2**52</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">, но &lt; </span><span style=" font-family:'Courier New,courier'; font-size:9pt;">2**53</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">), наилучшее значение для N - это 56: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; 2**52 &lt;=  2**56 // 10  &lt; 2**53</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">True</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Т</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">о есть 56 - единственное значение для N, которое оставляет J с точно 53 битами. Наилучшее возможное значение для J тогда есть округленное частное: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; q, r = divmod(2**56, 10)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; r</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">6</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Поскольку остаток больше, чем половина от 10, наилучшее приближение получается путем округления в большую сторону: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; q+1</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">7205759403792794</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Поэтому лучшее возможное приближение к 1/10 в двойной 754 точности: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">7205759403792794 / 2 ** 56</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Деление числителя и знаменателя на два сокращает дробь к: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">3602879701896397 / 2 ** 55</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Заметьте, что поскольку мы округлили в большую сторону, это в действительности немного больше, чем 1/10; если мы бы так не округляли, частное было бы немного меньше, чем 1/10. Но в любом случае оно не может быть точно равно 1/10! </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Так компьютер никогда не &quot;видит&quot; 1/10: что он видит - это точная дробь, данная выше, наилучшее 754 двойное приближение, которое можно получить: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; 0.1 * 2 ** 55</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">3602879701896397.0</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Если мы умножим ту дробь на 10**55, мы можем увидеть значение до 55 десятичных цифр: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; 3602879701896397 * 10 ** 55 // 2 ** 55</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">1000000000000000055511151231257827021181583404541015625</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">обозначаемое, что точное число, хранимое в компьютере, приравнено к десятичному значению 0.1000000000000000055511151231257827021181583404541015625. Вместо отображения полного десятичного значения, многие языки (включая более старые версии Python) округляют результат до 17 значащих цифр: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; format(0.1, '.17f')</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">'0.10000000000000001'</span><span style=" font-family:'DejaVu LGC Sans'; font-size:9pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Модули fractions (docs.python.org/3/library/fractions.html#module-fractions) и decimal (docs.python.org/3/library/decimal.html#module-decimal) легко выполняют эти вычисления: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; from decimal import Decimal</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; from fractions import Fraction</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; Fraction.from_float(0.1)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">Fraction(3602879701896397, 36028797018963968)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; (0.1).as_integer_ratio()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">(3602879701896397, 36028797018963968)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; Decimal.from_float(0.1)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">Decimal('0.1000000000000000055511151231257827021181583404541015625')</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">&gt;&gt;&gt; format(Decimal.from_float(0.1), '.17')</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;">'0.10000000000000001'</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600;">Создано</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">2017-07-02</span></p></body></html>