<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:xx-large; font-weight:600; text-decoration: underline; color:#335295;">9.5.3 Перемещение по </span><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:xx-large; font-weight:600; font-style:italic; color:#335295;">Recordset</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-weight:600; font-style:italic; color:#000000;">Перемещение по Recordset в ADO/VBA, свойства BOF, EOF, Bookmark, методы Move(), MoveNext(), MovePrevious(), MoveFirst(), MoveLast(), Find(), Seek()</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">После того, как объект Recordset создан, нам необходимо выполнять с ним различные операции. Самое простое действие, с которого мы начнем — перемещение по объекту Recordset.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">В Recordset всегда имеется ограниченное количество записей (столько, сколько мы получили с источника). Изначально курсор устанавливается на первую запись в Recordset (убедиться в этом можно при помощи свойства AbsolutePosition). Однако, если мы дадим команду MovePrevious() (один раз), ошибки не произойдет (если мы попробуем выполнить команду MovePrevious() второй раз, то возникнет ошибка). AbsolutePosition вернет загадочное значение (-2). Связано это с тем, в Recordset перед первой записью, полученной с источника помещается специальная запись BOF (от Begin Of File, хотя никаких файлов, конечно же, нет). Проверить, находимся ли мы на этой специальной записи, можно при помощи свойства BOF. Например, такой код:</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Debug.Print rs.BOF</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">rs.MovePrevious</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Debug.Print rs.BOF</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">вернет нам вначале False, а затем True.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Точно так же после последней записи в Recordset находится специальная запись EOF (End Of File). Проверить, не находится ли курсор на ней, можно при помощи аналогичного одноименного свойства EOF.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Иногда бывает так, что сразу после открытия Recordset и BOF, и EOF одновременно возвращают True. Объяснение такой ситуации очень простое — в Recordset с источника по каким-то причинам не вернулось ни одной записи. Рекомендуется во избежание неожиданностей предусматривать сразу после открытия Recordset проверку на наличие в нем записей.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">После того, как мы определились с нашей текущей позицией в Recordset, необходимо разобраться с тем, как можно по нему перемещаться. Проще всего это делать при помощи методов Move…(). Вот их краткое описание:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:12px; color:#000000;" style=" margin-top:12px; margin-bottom:10px; margin-left:60px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px; font-style:italic;">Move()</span><span style=" font-size:12px;"> — этот метод принимает два параметра: NumRecords — на сколько записей необходимо переместиться (это число может быть и отрицательным, что значит — переместиться назад) и второй параметр — необязательный — имя закладки, с которой нужно начать перемещение. Можно использовать три встроенные закладки: для текущей, первой и последней записи. Если имя закладки не указано, то перемещение начинается с текущей позиции.</span></li>
<li style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:12px; color:#000000;" style=" margin-top:5px; margin-bottom:12px; margin-left:60px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px; font-style:italic;">MoveFirst()</span><span style=" font-size:12px;">, </span><span style=" font-size:12px; font-style:italic;">MoveLast()</span><span style=" font-size:12px;">, </span><span style=" font-size:12px; font-style:italic;">MoveNext()</span><span style=" font-size:12px;"> и </span><span style=" font-size:12px; font-style:italic;">MovePrevious()</span><span style=" font-size:12px;"> — назначение этих методов понятно из названия: перемещение на первую, последнюю, следующую и предыдущую запись соответственно.</span></li></ul>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Необходимо отметить, что перемещение назад (при помощи MovePrevious() или Move() с отрицательным значением) для курсора, открытого как Forward-only, может привести к совершенно непредсказуемому результату (в зависимости от источника данных) — от ошибки до перехода на случайную запись.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Чаще всего для прохода по всем записям используется такой нехитрый алгоритм:</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#335295;">rs.MoveFirst</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Do Until rs.EOF</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">'что-то делаем с каждой записью, например,</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">'получаем значение нужного поля</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">rs.MoveNext</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Loop</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Если нужно напрямую перепрыгнуть на нужную запись, можно использовать методы Find() и Seek().</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Метод </span><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Find()</span><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;"> предназначен для поиска по значению одного столбца. Он принимает в качестве параметра критерий поиска, насколько нужно отступить от исходной позиции, направление поиска и откуда нужно начать поиск. Очень удобно, что при определения критерия поиска можно использовать оператор Like с подстановочными символами. При обнаружении нужной записи метод Find() переставляет курсор на найденную запись, если же запись не обнаружена, то курсор устанавливается на EOF (или BOF, если поиск был назад). Например, чтобы найти все немецкие фирмы в нашем Recordset для таблицы Customers, можно использовать код вида</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">rs.Find &quot;country = 'Germany'&quot;</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Do While Not rs.EOF</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Debug.Print &quot;Название фирмы: &quot;; rs.Fields(&quot;CompanyName&quot;)</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">mark = rs.Bookmark</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">rs.Find &quot;country = 'Germany'&quot;, 1, adSearchForward, mark</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Loop</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">В этом примере используются еще незнакомые нам объекты Fields и Bookmark, но их назначение понятно: объект Field нужен нам, чтобы вывести название фирмы, а объект Bookmark — чтобы продолжить поиск позиции +1 от последней найденной записи.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Метод </span><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; font-style:italic; color:#000000;">Seek()</span><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;"> отличается от метода Find() тем, что они ищет значение по индексу (объект Index для Recordset создается либо программным способом, либо автоматически — если на таблицу, на основе который был создан Recordset, было наложено ограничение Primary Key). Этот метод работает только для серверных курсоров с типом команды TableDirect, и поэтому к использованию не рекомендуется.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Теперь — о еще одном свойстве, которое может сильно помочь в перемещении по Recordset (и которое уже встречалось в наших примерах) — свойстве Bookmark. Это свойство очень простое — достаточно присвоить его значение переменной типа Variable, когда указатель стоит в нужном месте Recordset, а затем присвоить этому свойству значение этой переменной, чтобы опять на него вернуться — как в нашем примере с поиском.</span></p>
<p style=" margin-top:15px; margin-bottom:10px; margin-left:30px; margin-right:30px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,Helvetica,sans-serif'; font-size:14px; color:#000000;">Вообще говоря, значение, которое возвращает это свойство, изначально совпадает с номером записи в Recordset, однако Microsoft честно предупреждает, что таким способом пользоваться закладкой очень не рекомендуется — если курсор стоит в одном и том же месте, свойство Bookmark может возвращать разные значения.</span></p></body></html>