<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Распоряжайтесь окнами сами</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="cs-vk"></a>Очень часто на всевозможных конференциях я видел вопросы, связанные с каким-либо действием над окном, закрыть окно, переместить, свернуть. Как я понял, народ очень желает получить контроль над всеми окнами и задачами, активными в данный момент в системе. Что-ж, пожалуйста; в этой статье я попробую растолковать как получать в свое распоряжение окна, задачи, приложения и т. д. чтобы дальше делать с ними все, что угодно. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычными способами то есть средствами Visual Basic вы можете контролировать только те окна, которые создает ваша программа, что категорически нас не устраивает. Так что бы мы делали, если бы не имели доступа к бездонным залежам функций WinAPI ?! Но это я так... Короче, использовать мы будем естесственно функции API. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Что нам надо для того, чтобы начать делать что-то с окном? Ответ - надо знать его <span style=" font-weight:600;">Handle</span>, то есть свойство окна <span style=" font-weight:600;">hWnd</span>. Запомните раз и на всегда: ключ к управлению окном - его свойство <span style=" font-weight:600;">hWnd</span>! Зная его, вы сможете вытворять с окном любые вещи. Великолепно, как же нам его узнать? Да с помощью все тех же функций API, а конкретно, функции <span style=" font-weight:600;">FindWindow</span>. Эта функция возвращает Handle окна по его свойству <span style=" font-weight:600;">Caption</span>. Вот ее определение: </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal _ </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">lpClassName As String, ByVal lpWindowName As String) As Long </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Пример использования (выдает hWnd Internet Explorer'а): </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">hW = FindWindow(vbNullString, &quot;about:blank - Microsoft Internet Explorer&quot; &amp; Chr(0)) </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Однако не торопитесь прыгать от радости и хлопать в ладоши :)  Вы видите, какой здоровенный caption пришлось впихать в параметр <span style=" font-weight:600;">lpWindowName</span>?! А ведь это еще только начало. Caption'ы постоянно меняются и за тем же IE невозможно все время уследить. Значит, нам надо где-то достать текущий заголовок нужного окна или процесса. Прямо у вас под пальцами есть прелестный пример :) Нажмите волшебную комбинацию CAD (Ctrl-Alt-Del) ОДИН РАЗ! Что вывалилось? Правильно, Task Manager. Если вы сейчас просматриваете эту статью в IE у меня на сайте, то вы вполне можете прочитать в списке задач такую строку: <span style=" font-style:italic;">www.chat.ru/~anti_loop/vbmisc/wnd.html - Microsoft Internet Explorer</span>. Ну или что-то в этом роде. Ну прямо бери ее и пихай в функцию FindWindow. Вот и я так подумал... </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После нескольких часов поисков в ИНете, я нашел процедурку, которая вываливает полный список всех активных задач в системе. Чуть-чуть пригладив ее, я привожу ее сейчас, а затем объясню, что здесь к чему: </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Sub GetTaskList() </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  'Получаем hWnd, который будет первым в списке </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  'через него, мы сможем отыскать другие задачи</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  CurrWnd = GetWindow(Me.hwnd, GW_HWNDFIRST) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  'Пока возвращаемый hWnd имеет смысл, выполняем цикл</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  Do While CurrWnd  0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    'Получаем длину имени задания по CurrW nd</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    Length = GetWindowTextLength(CurrWnd) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    'Получить имя задачи из списка </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    ListItem = Space(Length + 1) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    Length = GetWindowText(CurrWnd, ListItem, Length + 1) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    'Если получили имя задачи, значит добавляем ее в список найденных </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    If Length &gt; 0 Then </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">      List1.AddItem ListItem</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    End If </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    'Переходим к следующей задаче из списка </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    CurrWnd = GetWindow(CurrWnd, GW_HWNDNEXT) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    DoEvents</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  Loop</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">End Sub  </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Прежде чем опробывать процедуру, вам надо добавить на форму элемент List под именем List1,объявить необъявленные здесь переменные, а также задать константы и написать declare следующих функций: </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Private Declare Function GetWindow Lib &quot;user32&quot; (ByVal hwnd As Long,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    ByVal wCmd As Long) As Long </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Private Declare Function GetWindowText Lib &quot;user32&quot; Alias &quot;GetWindowTextA&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    (ByVal hwnd As Long, ByVal lpString As String, ByVal cch As Long) As Long </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Private Declare Function GetWindowTextLength Lib &quot;user32&quot; Alias</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">    &quot;GetWindowTextLengthA&quot; (ByVal hwnd As Long) As Long </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#0000ff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Const GW_HWNDFIRST = 0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Const GW_HWNDNEXT = 2  </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#0000ff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После отработки функции, в элементе List вы получите список всех имеющихся в наличие активных задач. Предупреждаю сразу: то, что вы там увидите, кардинальным образом отличается от того, что вы видите по комбинации CAD. Во-первых, задач больше в 3-4 раза, во-вторых, там есть настолько экзотические, что я о них до того, как запустил эту программу и не подозревал, например всплыло какое-то &quot;Напоминание&quot;, а также &quot;Индикатор батарей&quot;, которые мой Minitower, спокойно стоящий себе под столом даже во сне-то не видел. Тем не менее, задача есть и вы можете на досуге поупражняться в &quot;снятии&quot; различных процессов, тем более, что мы этим сейчас и займемся. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как лично вы будете использовать полученный список задач решать уже не мне. Я же покажу все на честном и открытом способе, то-есть на том List'е, который мы так успешно сформировали. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, как же снять задачу так, чтобы та даже не пискнула? Функция <span style=" font-weight:600;">PostMessage</span> очень поможет нам в этом. Дайте ей hWnd жертвы, а также укажите что ей передать и она сделает это! Хотите передать &quot;бомбу&quot; - передавайте. Бомба представляет собой константу WM_CLOSE, получив которую в качестве сообщение, приложение тихо себе загнется. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Добавьте к предыдущему проекту на форму еще одну кнопку Command1, а также допишите следующий код: </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Const WM_CLOSE = &amp;H10</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#0000ff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Private Sub Command1_Click()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  Dim hW as Long</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  hW=FindWindow(vbNullString,List1.Text &amp; Chr(0))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  PostMessage hW,WM_QUIT,0,0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#0000ff;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Private Sub Form_Load()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">  GetTaskList</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">End Sub </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обращаю ваше внимание, что это не полная программа, а только ее фрагменты. Не забудьте объявлять переменные! </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Псле запуска, выберите интересующее вас задание из списка, и нажмите на кнопку. Задание должно исчезнуть даже не пискнув. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, получив hWnd окна, вы теперь можете делать с ним все, что заблагорассудится, для этого надо только уметь использовать нужные функции API.</p></body></html>