<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Защита проекта VBA в MS Excel</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/infosecurity/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Информационная безопасность *</span></a><a href="https://habr.com/ru/hub/vba/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Visual Basic for Applications *</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Из песочницы </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post-content-body"></a><span style=" font-size:8.25pt;">В</span><span style=" font-size:8.25pt;">сем привет! Я обычный пользователь MS Excel. Не являющийся профессиональным программистом, но накопивший достаточно опыта, для установки и обхода защиты проектов VBA.<br /><br /></span><span style=" font-size:8.25pt; font-weight:600;">Дисклеймер:</span><span style=" font-size:8.25pt;"><br /><br />В данной статье рассмотрены виды защиты проектов VBA, от несанкционированного доступа. Их сильные и слабые стороны – ранжирование.<br /><br />Цель статьи показать слабые и сильные стороны каждого вида защиты проекта VBA в MS Office.<br /><br />Демонстрация разработанных инструментов, в надстройке </span><span style=" font-size:8.25pt; font-weight:600;">Macro Tools VBA</span><span style=" font-size:8.25pt;">, для снятия и установки той или иной защиты. <br /><br />Все инструменты реализованы стандартными средствами VBA, без использования дополнительных библиотек. <br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Главная панель Надстройки Macro Tools VBA<br /></span><a name="habracut"></a><span style=" font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Первый вид защиты — Обычный пароль</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Время на снятие: мгновенно<br /><br />Недостаток: быстрый доступ к запароленному модулю VBA<br /><br />Стандартный инструмент (В среде VBE:</span><span style=" font-size:8.25pt; font-style:italic;"> панель Tools -&gt; VBAProject Properties -&gt; Protection</span><span style=" font-size:8.25pt;">). <br /><br />Самая легко снимающаяся защита. В интернете легко находится код, для снятия данной защиты. <br /><br />Данную защиту можно снять следующим инструментом:<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Второй вид защиты — Project is Unviewable</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Время на снятие:  от 10 до 15 мин (в ручную)<br /><br />Недостаток: доступ к исходному коду модуля VBA<br /><br />Один из самых распространённых видов защит.  Встречается в 95% файлах с защитой модуля VBA. При попытке открыть проект, открывается диалоговое окно, с  сообщением:  </span><span style=" font-size:8.25pt; font-weight:600;">Project is Unviewable.</span><span style=" font-size:8.25pt;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Большинство пользователей Excel, не могут снять данную защиту, так как она имеет множество вариации и нюансов, для ее снятие нужно иметь представление о внутренней структуре файла Excel.<br /><br />Основан, данный вид защиты, на изменение ключей: <br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:8.25pt;">CMG=«4A488FCC54D054D054D054D0»</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:8.25pt;">DPB=«0B09CE0F8E108E108E»</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:8.25pt;">GC=«CCCE09520B120C120CED»</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /><br />в файле </span><span style=" font-family:'Courier New'; font-size:8.25pt;">vbaProject.bin</span><span style=" font-size:8.25pt;">. <br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Кратко, как создается данная защита</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Для создания данной защиты нужно, разархивировать файл Excel. Перейти в архиве в папку </span><span style=" font-size:8.25pt; font-weight:600;">xl</span><span style=" font-size:8.25pt;">, открыть файл </span><span style=" font-size:8.25pt; font-weight:600;">vbaProject.bin</span><span style=" font-size:8.25pt;">,  в конце файла находятся наши ключи, редактируем значения ключей на пусто, сохраняем файл. Переводим наш архив, обратно в файл Excel. Готово! <br /><br />Это самый простой вариант данной защиты, но существует множество модификаций.<br /><br />Алгоритм снятия защиты </span><span style=" font-size:8.25pt; font-weight:600;">Project is Unviewable.</span><span style=" font-size:8.25pt;"><br /><br />1)  Разархивируем подопытный файл, переходим в файл  </span><span style=" font-size:8.25pt; font-weight:600;">…\xl\_rels\workbook.xml.rels</span><span style=" font-size:8.25pt;"><br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;"><br /></span><span style=" font-size:8.25pt;"><br /><br />2)      В файле</span><span style=" font-size:8.25pt; font-weight:600;"> workbook.xml.rels</span><span style=" font-size:8.25pt;">  ищем строку, содержащую слово  </span><span style=" font-size:8.25pt; font-weight:600;">vbaProject</span><span style=" font-size:8.25pt;">, обычно имеет следующий вид:  </span><span style=" font-size:8.25pt; font-weight:600;">/&gt;</span><span style=" font-size:8.25pt;">. В этой строке нас интересует ключ </span><span style=" font-size:8.25pt; font-weight:600;">Target</span><span style=" font-size:8.25pt;">,иего значение. Значение является название файла, в котором находится проект VBA. Иногда, защищающий меняет значения ключа на </span><span style=" font-size:8.25pt; font-weight:600;">printerSettings.bin</span><span style=" font-size:8.25pt;">.Получается маскировка файла с проектом VBA  под другой файл.<br /><br />3)      Открываем на редактирование файл, указанный в  ключе </span><span style=" font-size:8.25pt; font-weight:600;">Target</span><span style=" font-size:8.25pt;">, ищем в файле ключи  </span><span style=" font-size:8.25pt; font-weight:600;">CMG, DPB, GC</span><span style=" font-size:8.25pt;">. И меняем в их названиях любую букву на любую другую, например: </span><span style=" font-size:8.25pt; font-weight:600;">CMC, DPC, CC</span><span style=" font-size:8.25pt;">. При поиске нужно быть аккуратным, так как защищающий может поместить  в проект форму,  подписью повторяющую один из ключей, например такую: </span><span style=" font-size:8.25pt; font-weight:600;">DPB=«0B09CE0F8E108E108E»</span><span style=" font-size:8.25pt;">. При ее изменении проект VBA, будет удален из книги Excel.  Сохраняем и закрываем файл.<br /><br />4)      Переводим архив обратно в файл Excel.<br /><br />5)      Запускаем приложение Excel, выполняем следующее: в </span><span style=" font-size:8.25pt; font-style:italic;">Центре управления безопасностью -&gt; Параметры макросов  -&gt; Отключить все макросы без уведомления</span><span style=" font-size:8.25pt;">. Перезапускаем Excel. Данная операция нужна, для блокировки защиты, которую иногда ставят авторы макросов. Данная защита реализована следующим образом. В модуле VBA «</span><span style=" font-size:8.25pt; font-weight:600;">ЭтаКнига</span><span style=" font-size:8.25pt;">», создается процедуры, реагирующие на события открытия книги или закрытия книги. Эти события обычно проверяют, наличие пароля на проект VBA, запрет сохранения и прочее.<br /><br />6)      Открываем файл. Если все правильно сделано то, Excel, будет ругаться на не правильные ключи, которые мы отредактировали, в пункте 3. Жмем, да, пока данные сообщения не закончатся и диалоговое окно закроется. <br /><br />      Если данное сообщение не появляется то, вы отредактировали не файл который содержит проект VBA.<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />7)      Открываем проект VBA. После всего, проект VBA должен быть доступен.<br /><br />8)      Но иногда защита не снимается, тогда нужно сохранить файл, проверить, что он действительно сохранился! И проделать повторно операции с 1 по 7. Обычно так происходит когда в файле </span><span style=" font-size:8.25pt; font-weight:600;">workbook.xml.rels </span><span style=" font-size:8.25pt;">в ключе </span><span style=" font-size:8.25pt; font-weight:600;">Target</span><span style=" font-size:8.25pt;">  установлено </span><span style=" font-size:8.25pt; font-weight:600;">printerSettings.bin</span><span style=" font-size:8.25pt;">.При сохранение,  Excel  исправляет это на значение на </span><span style=" font-size:8.25pt; font-weight:600;">vbaProject.bin</span><span style=" font-size:8.25pt;"><br /><br />Данную защиту можно установить и снять следующим инструментом:<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /></span><span style=" font-size:8.25pt; font-weight:600;">Третий вид защиты — Hidden  Module, скрытые модули VBA</span><span style=" font-size:8.25pt;"><br /><br />Время на снятие:  от 15 до 20 мин (нужен редактор OLE — объектов, Structured Storage Viewer, например.<br /><br />Недостаток: доступ к коду модуля VBA<br /><br />Менее распространенный вид  защиты обычно встречается в комбинации с защитой </span><span style=" font-size:8.25pt; font-weight:600;">Project is Unviewable. </span><span style=" font-size:8.25pt;">При установке данной защиты модуль VBA не отображается в проекте книги Excel. О его существовании можно узнать, проанализировав код VBA (что требует время!) или открыть файл Excel в программе  </span><span style=" font-size:8.25pt; font-weight:600;">OpenOffice  или  LibreOffice </span><span style=" font-size:8.25pt;">(так же можно смотреть код при защите Project is Unviewable, но данный способ не дает возможность получить рабочий файл, без пароля). <br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Просмотр кода VBA в  </span><span style=" font-size:8.25pt; font-weight:600;">LibreOffice</span><span style=" font-size:8.25pt;"><br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Кратко, как создается данная защита</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Для создания данной защиты нужно отредактировать файл  с проектом VBA — </span><span style=" font-size:8.25pt; font-weight:600;">vbaProject.bin  </span><span style=" font-size:8.25pt;">или </span><span style=" font-size:8.25pt; font-weight:600;">printerSettings.bin</span><span style=" font-size:8.25pt;">,в зависимости от настроек в файле </span><span style=" font-size:8.25pt; font-weight:600;">…\xl\_rels\workbook.xml.rels</span><span style=" font-size:8.25pt;">. В конце файла удаляются строки вида: </span><span style=" font-size:8.25pt; font-weight:600;">Module1=32, 32, 635, 330, Z</span><span style=" font-size:8.25pt;">.  С нужными названиями модулей.<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Для снятия данной защиты нужно в файле </span><span style=" font-size:8.25pt; font-weight:600;">vbaProject.bin — </span><span style=" font-size:8.25pt;">восстановить удаленные записи модулей.<br /><br />Данную защиту можно установить следующим инструментом.<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Четвертый вид защиты — Обфускация кода</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Время на снятие:  неизвестно, зависит от объема кода и пере использования частей кода<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /></span><span style=" font-size:8.25pt; font-style:italic;">Обфусцированный код VBA</span><span style=" font-size:8.25pt;"><br /><br />Недостаток:  необходимость тестирование файла после обфускации, на работоспособность<br /><br />Крайне редкий вид защиты, основанный на изменении исходного кода VBA, в не удобочитаемый вид для человека. Удаляются все комментарии, форматирование кода, переименовываются названия всех переменных,  процедур, функций, модулей и прочего. Злоумышленнику никогда не удастся восстановить первоначальный вид кода, и потребует достаточно много времени для, его восстановления в удобно читаемый вид для человека.  <br /><br />Для де-обфускации кода нужно иметь  время, специализированное ПО.<br /><br />Данную защиту можно установить следующим инструментом.<br /><br /></span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Пятый вид защиты — Перенос кода в dll</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Время на снятие:  неизвестно, зависит от языка программирования и квалификации<br /><br />Недостаток:  необходимости в дополнительном  файле dll<br /><br />Один из самых редких видов защиты. Основная идея перенос основного кода в отдельную библиотеку dll, написанную на любом другом языке программирования. Не распространённость данный вид защиты получил по следующей причине,  необходимости за файлом Excel, «таскать» дополнительный файл, dll.<br /><br />Для получения доступа к коду dll, нужно обладать специальными знаниями.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Заключение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />В заключении хочу выделить бесполезность защит:  </span><span style=" font-size:8.25pt; font-weight:600;">Project is Unviewable и Hidden  Module</span><span style=" font-size:8.25pt;"> которые, по существу ни отчего не защищают. Позволяют просматривать код VBA, без изменения исходного  файла, в таких программах как </span><span style=" font-size:8.25pt; font-weight:600;">OpenOffice  </span><span style=" font-size:8.25pt;">или</span><span style=" font-size:8.25pt; font-weight:600;">  LibreOffice. </span><span style=" font-size:8.25pt;">Так и снимаются без особых проблем. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Теги: </span><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BVBA%5D"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">VBA</span></a><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D0%B0%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0%20VBA%5D"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">защита проекта VBA</span></a><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BProject%20is%20Unviewable%5D"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Project is Unviewable</span></a><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BHidden%20%20Module%5D"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Hidden Module</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Хабы: </span><a href="https://habr.com/ru/hub/infosecurity/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Информационная безопасность </span></a><a href="https://habr.com/ru/hub/vba/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Visual Basic for Applications</span></a><span style=" font-size:8.25pt; color:#000000;"> </span></p></body></html>